<!DOCTYPE html>
<html>
  <head lang="ja">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta charset="UTF-8" />
    <meta http-equiv="content-language" content="ja" />
    <title>浦和高校 文化祭企画 入退場管理</title>
    <meta name="author" content="浦和高校 プログラミング研究会" />
    <meta name="owner" content="浦和高校 プログラミング研究会" />
    <meta name="designer" content="Kevin-Hashi hiromi1630" />
    <meta
      name="copyright"
      content="Copyright (C) 2022 浦和高校 プログラミング研究会"
    />
    <meta http-equiv="pragma" content="no-cache" />
  </head>

  <body>
    <script src="./q.js"></script>
    <script>
      window.onload = (e) => {
        let video = document.createElement("video");
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let msg = document.getElementById("msg");

        const userMedia = { video: { facingMode: "environment" } };
        navigator.mediaDevices.getUserMedia(userMedia).then((stream) => {
          video.srcObject = stream;
          video.setAttribute("playsinline", true);
          video.play();
          startTick();
        });

        function startTick() {
          msg.innerText = "Loading video...";
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            let img = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let code = jsQR(img.data, img.width, img.height, {
              inversionAttempts: "dontInvert",
            });
            if (code) {
              drawRect(code.location); // Rect
              msg.innerText = code.data; // Data
            } else {
              msg.innerText = "Detecting QR-Code...";
            }
          }
          setTimeout(startTick, 250);
        }

        function drawRect(location) {
          drawLine(location.topLeftCorner, location.topRightCorner);
          drawLine(location.topRightCorner, location.bottomRightCorner);
          drawLine(location.bottomRightCorner, location.bottomLeftCorner);
          drawLine(location.bottomLeftCorner, location.topLeftCorner);
        }

        function drawLine(begin, end) {
          ctx.lineWidth = 4;
          ctx.strokeStyle = "#FF3B58";
          ctx.beginPath();
          ctx.moveTo(begin.x, begin.y);
          ctx.lineTo(end.x, end.y);
          ctx.stroke();
        }
      };
    </script>
    <h1>第75回浦高祭 入退場管理システム</h1>
    <div id="wrapper">
      <div id="msg">Unable to access video stream.</div>
      <canvas id="canvas"></canvas>
    </div>
  </body>
</html>
