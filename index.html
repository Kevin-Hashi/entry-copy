<!DOCTYPE html>
<html>
  <head lang="ja">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta charset="UTF-8" />
    <meta http-equiv="content-language" content="ja" />
    <title>浦和高校 文化祭企画 入退場管理</title>
    <meta name="author" content="浦和高校 プログラミング研究会" />
    <meta name="owner" content="浦和高校 プログラミング研究会" />
    <meta name="designer" content="Kevin-Hashi hiromi1630" />
    <meta
      name="copyright"
      content="Copyright (C) 2022 浦和高校 プログラミング研究会"
    />
    <meta http-equiv="pragma" content="no-cache" />
  </head>

  <body>
    <script src="./q.js"></script>
    <script>var DetectedCount = 0, DetectedCode = "";
var video, tmp, tmp_ctx, jan, prev, prev_ctx, width, height, mwidth, mheight, x1, y1;
window.addEventListener('load', function (event) {
    video = document.createElement('video');
    video.setAttribute("autoplay", "");
    video.setAttribute("muted", "");
    video.setAttribute("playsinline", "");
    video.onloadedmetadata = function (e) { video.play(); };
    prev = document.getElementById("preview");
    prev_ctx = prev.getContext("2d");
    tmp = document.createElement('canvas');
    tmp_ctx = tmp.getContext("2d");
    jan = document.getElementById("jan");

    //カメラ使用の許可ダイアログが表示される
    navigator.mediaDevices.getUserMedia(
        //マイクはオフ, カメラの設定   背面カメラを希望する 640×480を希望する
        { "audio": false, "video": { "facingMode": "environment", "width": { "ideal": 640 }, "height": { "ideal": 480 } } }
    ).then( //許可された場合
        function (stream) {
            video.srcObject = stream;
            //0.5秒毎にスキャンする
            setTimeout(Scan, 500, true);
        }
    ).catch( //許可されなかった場合
        function (err) { jan.value += err + '\n'; }
    );

    function Scan(first) {
        if (first) {
            //選択された幅高さ
            width= video.videoWidth;
            height = video.videoHeight;
            //画面上の表示サイズ
            prev.style.width = (width/ 2) + "px";
            prev.style.height = (height / 2) + "px";
            //内部のサイズ
            prev.setAttribute("width", width);
            prev.setAttribute("height", height);
            mwidth= width* 0.5;
            mheight = width* 0.2;
            x1 = (width- mwidth) / 2;
            y1 = (height - mheight) / 2;
        }
        prev_ctx.drawImage(video, 0, 0, width, height);
        prev_ctx.beginPath();
        prev_ctx.strokeStyle = "rgb(255,0,0)";
        prev_ctx.lineWidth = 2;
        prev_ctx.rect(x1, y1, mwidth, mheight);
        prev_ctx.stroke();
        tmp.setAttribute("width", mwidth);
        tmp.setAttribute("height", mheight);
        tmp_ctx.drawImage(prev, x1, y1, mwidth, mheight, 0, 0, mwidth, mheight);

        tmp.toBlob(function (blob) {
            let reader = newidthFileReader();
            reader.onload = function () {
                let config = {
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader"],
                        multiple: false, //同時に複数のバーコードを解析しない
                    },
                    locator: { patchSize: "large", halfSample: false },
                    locate: false,
                    src: reader.result,
                };
                Quagga.decodeSingle(config, function () { });
            }
            reader.readAsDataURL(blob);
        });
        setTimeout(Scan, 50, false);
    }

    Quagga.onDetected(function (result) {
        //読み取り誤差が多いため、3回連続で同じ値だった場合に成功とする
        if (DetectedCode == result.codeResult.code) {
            DetectedCount++;
        } else {
            DetectedCount = 0;
            DetectedCode = result.codeResult.code;
        }
        if (DetectedCount >= 3) {
            console.log(result.codeResult.code);
            jan.value += result.codeResult.code + '\n';
            jan.scrollTop = jan.scrollHeight;
            DetectedCode = '';
            DetectedCount = 0;
        }
    });
});</script>
    <h1>第75回浦高祭 入退場管理システム</h1>
    <div><canvas id="preview"></canvas></div>
    <textarea id="jan" rows="8" cols="40"></textarea>
  </body>
</html>
